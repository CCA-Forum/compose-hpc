#!/bin/bash 

function confirm {
    if [ -n "`which dialog`" ]; then
	dialog --yesno "$1" 20 68
	if [ $? != 0 ]; then
	    exit 1
	fi
    else
	echo "$1"
	read -p "[y/n]" 
	if [ ! $REPLY = "y" ]; then
	    exit 1
	fi 
    fi
}

if [ "x$1" == "x--undo" ]; then
    flags="-R"
    lsflags="-r"
    HELP='You are now running in reverse/UNDO mode.'
else
    lsflags=""
    flags="" #"--merge"
    HELP="You can undo this operation by running \"$0 --undo\"."
fi

confirm \
"**************************************************************
* WARNING                                                    *
**************************************************************
This script will apply several patches to your chapel compiler
and then recompile it.

The chapel compiler that will be modified is located in
@CHAPEL_ROOT@.

$HELP

Type 'y' to proceed and 'n' to cancel this operation.
" 

# sanity check
base=`pwd`
if [ ! -e Doxyfile ]; then
    echo "**ERROR: please run this script from builddir"
fi

# apply the patches
pushd @CHAPEL_ROOT@ || exit 1
for p in `ls -1 $lsflags "$base/@top_srcdir@/chapel-patches"`; do
    echo "[" `basename $p` "]"
    patch $flags -p3 -u < "$base/@top_srcdir@/chapel-patches/$p" || echo "**ERROR"
done

# we have to manually remove these files which have been created by the patches
if [ "x$1" == "x--undo" ]; then
    rm -f examples/borrowed/borrowed_array.chpl examples/borrowed/borrowed_data.h
fi

popd
echo "**clean"
make -C @CHAPEL_ROOT@ clean 
echo "**compiling"
make -C @CHAPEL_ROOT@ CHPL_COMM=@CHPL_COMM@


