From 36e9c6ef68807ff10c3ddc866e082c97314474e3 Mon Sep 17 00:00:00 2001
From: Adrian Prantl <adrian@llnl.gov>
Date: Wed, 25 Jul 2012 11:38:12 -0700
Subject: [PATCH 07/11] implement dual atext() handlers for locale 0 and others

---
 runtime/src/chplinit.c |   35 +++++++++++++++++++++++------------
 1 files changed, 23 insertions(+), 12 deletions(-)

diff --git a/runtime/src/chplinit.c b/runtime/src/chplinit.c
index ee66c18..1b8d0ce 100644
--- a/runtime/src/chplinit.c
+++ b/runtime/src/chplinit.c
@@ -177,14 +177,23 @@ static void chpl_library_init(void) {
 }
 
 /**
- * chpl_init_library() installs this as an atexit() handler.
+ * chpl_init_library() installs this as an atexit() handler for locale 0.
  */
-static void chpl_library_shutdown(void) {
-  chpl_msg(2, "[locale = 0] Shutting down Chapel runtime.\n");
+static void chpl_library_shutdown_locale_0(void) {
+  chpl_msg(2, " [locale = %d] Shutting down Chapel runtime.\n", chpl_localeID);
   chpl_gen_shutdown(&chpl_wide_endCount_global);
   chpl_exit_all(0);
 }
 
+/**
+ * chpl_init_library() installs this as an atexit() handler for
+ * non-zero locales.
+ */
+static void chpl_library_shutdown_locale_n(void) {
+  chpl_msg(2, " [locale = %d] Shutting down Chapel runtime.\n", chpl_localeID);
+  chpl_exit_all(0);
+}
+
 static bool chpl_init_library_called = false;
 
 /**
@@ -205,18 +214,20 @@ int chpl_init_library(int argc, char* argv[]) {
   if (!chpl_init_library_called) {
     chpl_init_library_called = true;
 
-    chpl_init(argc, argv);      // establishes "barrier before main"
+    // establishes "barrier before main"
+    chpl_init(argc, argv);
 
-    if (chpl_localeID != 0) {   // only locale #0 returns control to the
-                                // external call site
-      chpl_msg(2, " [locale = %d] Shutting down Chapel runtime.\n", chpl_localeID);
-      chpl_exit_all(0);         // all other locales can be stopped, we are done
-    } else {
-      atexit(&chpl_library_shutdown);
+    if (chpl_localeID == 0) {
+      // register master exit handler
+      atexit(&chpl_library_shutdown_locale_0);
+      // initialize Chapel runtime
       chpl_task_callMain(chpl_library_init);
+
+    } else {
+      // register other exit handlers
+      atexit(&chpl_library_shutdown_locale_n);
     }
   }
 
   return chpl_localeID;
-}
-
+}
\ No newline at end of file
-- 
1.7.0.4

